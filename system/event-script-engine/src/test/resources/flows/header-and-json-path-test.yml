flow:
  id: 'header-and-json-path-test'
  description: 'Test input data mapping of headers'
  ttl: 10s

first.task: 'no.op'

#
# JSON-Path "$.input.body.hello" is actually the same as "input.body.hello"
# The basic retrieval method using "input.body.hello" is more efficient than JSON-Path
# It is here for testing JSON-Path feature only.
#
# You should only use JSON-Path for more complex use cases.
#
# The plugin "listOfMap()" is used to Convert map of lists to list of maps where
# the map of lists may be generated by a JSON-Path wildcard search.
#
# Please see examples in the JavaDoc in the ListOfMap plugin class and the headerAndJsonPathTest in FlowTests.
#
tasks:
  - input:
      # this pass all input headers as an input map
      - 'input.header -> *'
      - '$.input.body.hello -> body'
    process: 'no.op'
    output:
      - 'text(application/json) -> output.header.content-type'
      - 'result -> output.body'
      # the following two JSON-Path searches would generate a map of lists
      - '$.input.body.list[*].world -> model.list.world'
      - '$.input.body.list[*].test -> model.list.test'
      - 'model.list -> output.body.list'
      # listOfMap plugin restores the original data structure for easy processing by another user function
      - 'f:listOfMap(model.list) -> output.body.normalized1'
      # listOfMap plugin can also process more than one map of lists and merge them together
      - '$.input.body.list[*].world -> model.list2.world'
      - '$.input.body.list[*].test -> model.list3.test'
      - 'f:listOfMap(model.list2, model.list3) -> output.body.normalized2'
      # updateListOfMap merges additional map of lists into a prior result of a list of maps
      - 'f:updateListOfMap(output.body.normalized1, input.body.more) -> output.body.more'
      - 'text(world) -> model.map.hello'
      - 'int(1) -> model.map.test'
      # removeKey removes one or more keys from a map or a list of maps
      - 'f:removeKey(model.map, text(test)) -> output.body.map'
      - 'model.map -> model.list_of_map[]'
      - 'model.map -> model.list_of_map[]'
      - 'f:removeKey(model.list_of_map, text(hello)) -> output.body.updated_list_map'
    description: 'Return result'
    execution: end
