purpose: "Retrieve a person's name and a list of accounts"

#
# The question section contains one or more questions to be executed orderly
#
question:
  - id: 'get-accounts'
    input:
      - 'input.body.person_id -> person_id'
    output:
      - 'person-name'
      - 'person-accounts'
  - id: 'fetch-account-details'
    for_each:
      - 'result.person_accounts -> model.account_id'
    input:
      - 'input.body.person_id -> person_id' # redundant statement but it does not matter
      - 'model.account_id -> account_id'
    output:
      - 'account-details'

#
# The concurrency value tells the system to control the number of parallel operation
# when spinning up requests based on the "for_each" directive.
# (default is 5 if not given. Min is 1 and max is 30 to avoid overwhelming a target service)
#
concurrency: 3
#
# Mapping result set to output
#
answer:
  - 'input.body.person_id -> output.body.person_id'
  - 'result.person_name -> output.body.name'
  - 'result.person_accounts -> model.ids.account_id'
  # demonstrate simple data transformation - removing the "id" field from result.account_details
  - 'f:removeKey(result.account_details, text(id)) -> model.account_details'
  # adding model.ids that contains the map of account_id to model.account_details
  - 'f:updateListOfMap(model.account_details, model.ids) -> output.body.account_details'
